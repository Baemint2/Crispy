<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:insert="~{layout/header :: header('Crispy')}"></th:block>
    <link rel="stylesheet" href="/css/summernote/summernote-lite.css">
    <link href="/css/board/board-detail.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="crispy-container">
    <aside th:replace="~{layout/sidebar :: sidebar}"></aside>
    <div>
        <main>
            <div class="main">
                <div>
                    <h2>공지사항</h2>
                </div>


                <div class="detail-contentinfo" id="detail-contentinfo">
                    <input type="hidden" id="hidden-empNo" th:value="${board.empNo}">
                    <div class="image-writer"></div>
                    <div class="contents-block">
                        <a class="contents-writer" id="contents-writer"></a>
                    </div>
                </div>
                <span type="text" name="boardTitle" id="boardTitle" class="form-control"
                      style="white-space: pre-line; border:none;" placeholder="제목은 15자 내외로 입력해주세요."
                      th:text="${board.boardTitle}"></span>
                <div class="contents-detailinfo">
                    <i class="fa-regular fa-clock"></i>&nbsp;<span id="create-dt" th:text="${board.createDt}"></span>
                    &nbsp;&nbsp;<i class="fa-regular fa-eye"></i>&nbsp;<span id="board-hit"
                                                                             th:text="${board.boardHit}"></span>
                    <!-- 좋아요 하트 -->
                    <span class="like-area" id="like-area">

                    </span>
                </div>
                <div class="mb-3">
                    <span id="boardContent" style="border:none;" name="boardContent" class="form-control" readonly
                          th:text="${board.boardContent}"></span>
                </div>
                <div th:if="${not #lists.isEmpty(boardFileList)}" class="file-attach">
                    <input type="hidden" name="empNo" th:value="${empNo}"/>
                    <div th:each="boardFile : ${boardFileList}" class="attach">
                        <a th:text="${boardFile.boardOrigin}"
                           th:href="@{/crispy/download(boardFileNo=${boardFile.boardFileNo})}">다운로드</a>
                    </div>
                </div>
                <div th:if="${#lists.isEmpty(boardFileList)}" class="file-attach">
                    <input type="hidden" name="empNo" th:value="${empNo}"/>
                    <div>첨부 파일 없음</div>
                </div>
                <button type="button" id="listBtn" class="btn btn-primary btn-lg">목록</button>

                <span th:if="${empNo} == ${board.creator}">
                    <div class="d-flex justify-content-end" id="btn">
                        <form id="frm-btn-delete" method="POST" action="/crispy/removeBoard">
                            <input type="hidden" name="boardNo" th:value="${board.boardNo}">
                            <button type="submit" id="btn-delete" class="btn btn-primary btn-lg">삭제</button>
                        </form>
                        <form id="frm-btn-modify" method="GET" action="/crispy/board-modify">
                            <input type="hidden" name="boardNo" th:value="${board.boardNo}">
                            <button type="submit" id="btn-modify" class="btn btn-primary btn-lg">수정</button>
                        </form>
                    </div>
                </span>
                <div th:if="${board == null}">
                    <p>해당 게시물을 찾을 수 없습니다.</p>
                </div>
            </div>
        </main>
        <footer th:replace="~{layout/footer :: footer}"></footer>
    </div>
    <script src="/js/summernote/summernote-lite.js"></script>
    <script src="/js/summernote/lang/summernote-ko-KR.js"></script>
    <script>
        /*        document.getElementById('btn-delete').addEventListener('click', (evt) => {
                    if (!confirm('해당 게시글을 삭제할까요?')) {
                        evt.preventDefault();
                    }
                });*/

        document.getElementById('listBtn').addEventListener('click',
            function () {
                window.location.href = '/crispy/board-list';
            });

        document.getElementById('frm-btn-modify').addEventListener('submit', function (event) {
            event.preventDefault();
            const boardNo = document.querySelector('input[name="boardNo"]').value;
            window.location.href = '/crispy/board-modify?boardNo=' + boardNo;
        });


        document.addEventListener('DOMContentLoaded', function () {
            const boardNo = document.querySelector('input[name="boardNo"]').value;

            // Function to increment board hit via AJAX
            const fnAddBoardHit = () => {
                $.ajax({
                    type: 'GET',
                    url: '/crispy/putBoardHit',
                    data: 'boardNo=' + boardNo,
                    dataType: 'json',
                    success: function (data) {
                        // Update the board hit count on success
                        // document.getElementById('board-hit').innerText = data.boardHit;
                    },
                    error: function (jqXHR) {
                        alert(jqXHR.statusText + '(' + jqXHR.status + ')');
                    }
                });
            };

            fnAddBoardHit();
        });

        $(document).ready(function () {
            const boardNo = '[[${board.boardNo}]]';
            const empNo = '[[${empNo}]]';

            // Function to load like status
            const loadLikeStatus = () => {
                $.ajax({
                    type: 'GET',
                    url: '/crispy/getLikeStatus',
                    data: {boardNo: boardNo, empNo: empNo},
                    dataType: 'json',
                    success: function (data) {
                        let likeIcon = data.check == 0
                            ? '<i class="fa-regular fa-heart" id="boardLike"></i>'
                            : '<i class="fa-solid fa-heart" id="boardLike"></i>';
                        $('#like-area').html(likeIcon + '<span>' + data.likeCount + '</span>');
                        handleLike();
                    },
                    error: function (jqXHR) {
                        alert(jqXHR.statusText + '(' + jqXHR.status + ')');
                    }
                });
            };

            // Function to handle like action
            const handleLike = () => {
                $('#like-area').on('click', '#boardLike', function (e) {
                    let check;

                    if ($(e.target).hasClass('fa-regular')) {
                        check = 0; // Not liked
                    } else {
                        check = 1; // Liked
                    }

                    const data = {
                        boardNo: boardNo,
                        empNo: empNo,
                        check: check
                    };

                    $.ajax({
                        type: 'POST',
                        url: '/crispy/like',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        dataType: 'json',
                        success: function (count) {
                            if (count === -1) {
                                console.log("좋아요 처리 실패");
                                return;
                            }

                            $(e.target).toggleClass('fa-regular fa-solid');
                            $(e.target).next('span').text(count);
                        },
                        error: function (jqXHR) {
                            console.log("예외 발생");
                            console.error(jqXHR);
                        }
                    });
                });
            };

            loadLikeStatus();
        });
    </script>
</div>
</body>
</html>
