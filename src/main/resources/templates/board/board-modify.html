<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<th:block th:insert="~{layout/header :: header('Crispy')}"></th:block>
	<link rel="stylesheet" href="/css/summernote/summernote-lite.css">

	<!-- 특정 페이지 css -->
	<link href="/css/board/board-modify.css" rel="stylesheet">
</head>
<body>

<div class="crispy-container">
	<aside th:replace="~{layout/sidebar :: sidebar}"></aside>
	<div>
		<main>
			<div class="main">
				<form id="frm-board-modify" method="POST" class="my-3" enctype="multipart/form-data">
					<input type="hidden" id="boardNo" class="board-no" th:value="${board.boardNo}">
					<!-- 제목 -->
					<h1 class="border-bottom py-2">게시물 수정하기</h1>
					<div class="col-md-5">
						<label for="cate" class="form-label">카테고리</label>
						<select class="form-select board-ct-no" id="cate" required="">
							<option value="">카테고리</option>
							<option value="0">공지사항</option>
							<option value="1">자유게시판</option>
						</select>
					</div>
					<label for="boardTitle" class="form-label">제목</label>
					<input type="text" name="boardTitle" id="boardTitle"
						class="form-control  board-title" th:value="${board.boardTitle}"/>
					<!-- 내용 -->
					<div class="mb-3">
							<label for="summernote" class="form-label mt-2">내용</label>
							<textarea id="summernote" name="editordata" class="board-content" th:text="${board.boardContent}"></textarea>
					</div>

					<!-- 파일 선택 -->
					<div class="file-attach">
						<label for="formFileMultiple" class="form-label">첨부파일</label>
						<input class="form-control" type="file" id="formFileMultiple" name="files" multiple>
						<ul id="existing-files">
							<li th:each="file : ${files}">
								<a th:href="@{/uploads/{fileName}(fileName=${file.boardRename})}" th:text="${file.boardOrigin}"></a>
								<button type="button" class="delete-file" th:data-file-id="${file.boardFileNo}">삭제</button>
							</li>
						</ul>
					</div>
					<div class="d-flex justify-content-end" id="btn">
						<input type="hidden" name="userNo"
							   value="${sessionScope.user.userNo}"> <a type="submit"
																	   id="cancelBtn" class="btn btn-primary btn-lg ">취소</a>
						<button type="button" id="addBtn" class="btn btn-primary btn-lg btn-modify">등록</button>
					</div>
				</form>
			</div>
		</main>
		<footer th:replace="~{layout/footer :: footer}"></footer>
	</div>
	<!-- 특정 JS -->

	<script src="/js/summernote/summernote-lite.js"></script>
	<script src="/js/summernote/lang/summernote-ko-KR.js"></script>
	<script>
		$(document).ready(function() {
		$('#summernote').summernote({
			placeholder: '500자',
			tabsize: 2,
			height: 400,
			toolbar: [
				['style', ['style']],
				['font', ['bold', 'underline', 'clear']],
				['color', ['color']],
				['para', ['ul', 'ol', 'paragraph']],
				['table', ['table']],
				['insert', ['link', 'picture', 'video']],
				['view', ['fullscreen', 'codeview', 'help']]
			],
			callbacks: {
				onInit: function() {
					$('#summernote').next().find('.note-placeholder').css('font-size', '16px');
				}
			},   width: '100%'
		});
	});
	</script>
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const addBoard = document.querySelector(".btn-modify");
			const boardNo = document.querySelector(".board-no").value
			addBoard.addEventListener("click", function () {
				const form = document.getElementById('frm-board-modify');
				const formData = new FormData(form);

				const data = {
					boardNo: parseInt(boardNo),
					boardCtNo: 1,
					boardTitle: document.querySelector(".board-title").value,
					boardContent: $('<div>').html($('#summernote').summernote('code')).text()
				}

				formData.append('boardDto', new Blob([JSON.stringify(data)], { type: 'application/json' }));

				const deleteFileNos = [];
				document.querySelectorAll('#existing-files .delete-file').forEach(function (button) {
					if (button.closest('li').style.display === 'none') {
						deleteFileNos.push(button.getAttribute('data-file-id'));
					}
				})
				formData.append('deletedFileNo', new Blob([JSON.stringify(deleteFileNos)], { type: 'application/json' }));


				fetch('/crispy/api/board/v1', {
					method: "PUT",
					body: formData
				}).then(response => response.json())
						.then(data => {
							alert(data.message)
							location.href = `/crispy/board-detail?boardNo=${boardNo}`
						}).catch(error => {
					alert("수정에 실패했습니다.");
				})
			})
		})
	</script>
</div>
</body>
</html>